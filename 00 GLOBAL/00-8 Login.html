<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Saba Foundation for Rare Diseases (SFRD)</title>
    <link rel="icon" href="../public/Logo_SFRD.jpg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md">
        <header class="text-center mb-8">
            <a href="/00 GLOBAL/00 Homepage.html" class="inline-block mx-auto">
                 <img src="../public/Logo_SFRD.jpg" alt="SFRD Logo" class="h-12 w-12">
            </a>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mt-2">Welcome Back</h1>
            <p class="text-gray-600 mt-2">Sign in to your SFRD account.</p>
        </header>

        <main class="bg-white p-6 md:p-10 rounded-2xl shadow-xl">
            <form id="login-form" class="space-y-6">
                
                <button type="button" id="google-signin-btn" class="w-full inline-flex justify-center py-3 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 48 48"><path d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"></path></svg>
                    Sign in with Google
                </button>

                <div class="my-4 flex items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-400">OR</span><div class="flex-grow border-t border-gray-300"></div></div>

                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="sr-only">Email</label>
                        <input type="email" id="login-email" name="email" placeholder="Email Address" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Password</label>
                        <input type="password" id="login-password" name="password" placeholder="Password" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                    </div>
                    <div class="text-sm">
                        <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot your password?</a>
                    </div>
                </div>
                
                <div>
                    <button type="submit" id="submit-button" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        Sign in
                    </button>
                </div>
            </form>
            
            <p class="text-center text-sm text-gray-500 mt-8">
                Don't have an account? <a href="./00-7 Register.html" class="font-medium text-indigo-600 hover:text-indigo-500">Register here</a>
            </p>
        </main>
    </div>

    <!-- Modal for messages -->
    <div id="message-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div id="modal-icon-container" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full sm:mx-0 sm:h-10 sm:w-10"></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3><div class="mt-2"><p class="text-sm text-gray-500" id="modal-message"></p></div></div></div></div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="button" id="modal-close-button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">OK</button></div>
            </div>
        </div>
    </div>

    <script src="./firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            sendPasswordResetEmail,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase init error", e);
            showMessage('Error', 'Could not connect to services. Please try again later.', 'error');
        }

        const dashboardUrls = {
            patient: '../01 PATIENT/01G Patient Dashboard.html',
            doctor: '../03 HCP/03E Healthcare Professional Dashboard.html',
            volunteer: '../04 VOLUNTEER/04E Volunteer Dashboard.html',
            epo: '../02 EPO/02E EPO Dashboard Code.html',
            ngo: '../05 NGO/05E NGO Dashboard Code.html',
            lab: '../06 LAB/06E Lab Dashboard.html',
            hospital: '../07 HOSPITAL/07E Hospital Dashboard.html',
            admin: '../SUPER ADMIN DASHBOARD.HTML',
            default: './00 Homepage.html' // Fallback to homepage
        };
        
        // --- Redirect if already logged in ---
        let isLoginInProgress = false;

        auth.onAuthStateChanged(async (user) => {
            if (user && !isLoginInProgress) {
                // User is signed in, redirect them away from the login page.
                console.log('User already logged in. Redirecting to dashboard...');
                isLoginInProgress = true;
                await handleLoginSuccess(user);
            }
        });

        // --- Core Login Logic ---
        async function handleLoginSuccess(user) {
            try {
                console.log('Handling login success for user:', user.uid);

                // Add a small delay to ensure Firestore data is synced
                await new Promise(resolve => setTimeout(resolve, 500));

                const userRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const role = userData.role;
                    const status = userData.status;

                    console.log('User data retrieved:', { role, status });

                    // Check for restricted access first
                    if (status === 'rejected' || status === 'suspended' || status === 'banned') {
                        console.log('Account access restricted, status:', status);
                        showMessage('Account Access Restricted', 'Your account access has been restricted. Please contact support.', 'error');
                        await auth.signOut();
                        return;
                    }

                    // For all valid users (profile_incomplete, pending_approval, approved),
                    // redirect to homepage where the appropriate buttons will be displayed
                    console.log('Login successful, redirecting to homepage');
                    console.log('Homepage will display appropriate action based on status:', status);

                    // Redirect to homepage - it will handle showing the correct buttons based on user status
                    window.location.href = './00 Homepage.html';

                } else {
                    // This case handles users who have an auth account but no Firestore document.
                    console.log('User profile not found in Firestore');
                    showMessage('Profile Not Found', 'User profile not found. Please register first.', 'error');
                    await auth.signOut();
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                showMessage('Login Error', 'Could not retrieve your profile. Please try again or contact support.', 'error');
                isLoginInProgress = false; // Reset the flag on error
            }
        }

        // Email/Password Login
        const loginForm = document.getElementById('login-form');
        const submitButton = document.getElementById('submit-button');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Signing In...`;

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;

            try {
                isLoginInProgress = true;
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await handleLoginSuccess(userCredential.user);
            } catch (error) {
                console.error("Login error:", error);
                showMessage('Login Failed', 'Invalid email or password. Please try again.', 'error');
                isLoginInProgress = false;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Sign in';
            }
        });

        // Google Sign-In
        const googleSigninBtn = document.getElementById('google-signin-btn');
        googleSigninBtn.addEventListener('click', async () => {
            if (isLoginInProgress) {
                console.log('Login already in progress, ignoring click');
                return;
            }

            const provider = new GoogleAuthProvider();
            try {
                console.log('Starting Google Sign-In...');
                isLoginInProgress = true;

                // Disable the button to prevent multiple clicks
                googleSigninBtn.disabled = true;
                googleSigninBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Signing in...`;

                const result = await signInWithPopup(auth, provider);
                console.log('Google Sign-In successful, handling login...');
                await handleLoginSuccess(result.user);
            } catch(error) {
                console.error("Google Sign-In Error", error);
                isLoginInProgress = false;

                // Handle specific error cases
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessage('Sign-In Cancelled', 'Google sign-in was cancelled.', 'info');
                } else if (error.code === 'auth/popup-blocked') {
                    showMessage('Popup Blocked', 'Please allow popups for this site and try again.', 'error');
                } else {
                    showMessage('Google Sign-In Failed', `Error: ${error.message}`, 'error');
                }
            } finally {
                // Re-enable the button
                googleSigninBtn.disabled = false;
                googleSigninBtn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 48 48"><path d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"></path></svg>Sign in with Google`;
            }
        });

        // Forgot Password
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    showMessage('Check Your Email', 'A password reset link has been sent to your email address.', 'success');
                } catch (error) {
                    console.error("Password reset error:", error);
                    showMessage('Error', `Could not send reset email. ${error.message}`, 'error');
                }
            }
        });

        lucide.createIcons();

        // Modal Logic
        const modal = document.getElementById('message-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        
        function showMessage(title, message, type = 'success') {
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const iconContainer = document.getElementById('modal-icon-container');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            if (type === 'success') {
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            } else if (type === 'error') {
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            } else { // info
                 iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            }
            modal.classList.remove('hidden');
        }

        modalCloseButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

    </script>

    <script src="../js/nav-menu.js"></script>
</body>
</html>
