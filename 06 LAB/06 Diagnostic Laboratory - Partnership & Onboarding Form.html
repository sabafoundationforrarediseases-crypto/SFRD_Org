<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Lab Partnership Onboarding | Saba Foundation for Rare Diseases (SFRD)</title>
    <link rel="icon" href="../../public/Logo_SFRD.jpg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/validation-styles.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-section {
            border-left: 3px solid #3B82F6; /* Blue-500 for diagnostic/medical partners */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-block mx-auto">
                 <svg class="h-16 w-16 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mt-2">Diagnostic Laboratory Partnership Onboarding</h1>
            <p class="text-gray-600 mt-2">Partnering to illuminate the path to diagnosis for millions.</p>
        </header>

        <!-- Main Form -->
        <form id="lab-onboarding-form" class="space-y-12">

            <!-- Section A: Laboratory Identity & Contact Information -->
            <section class="bg-white p-6 rounded-lg shadow-sm form-section pl-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-1">Section A: Laboratory Identity & Contact</h2>
                <p class="text-gray-500 mb-6">This information helps us create your lab's official profile in our national diagnostic alliance.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="labName" class="block text-sm font-medium text-gray-700">Full Legal Name of Laboratory <span class="text-red-500">*</span></label>
                        <input type="text" id="labName" name="labName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="brandName" class="block text-sm font-medium text-gray-700">Brand Name (if different)</label>
                        <input type="text" id="brandName" name="brandName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="websiteUrl" class="block text-sm font-medium text-gray-700">Official Website URL</label>
                        <input type="url" id="websiteUrl" name="websiteUrl" placeholder="https://www.yourlab.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="hqAddress" class="block text-sm font-medium text-gray-700">Headquarters Address <span class="text-red-500">*</span></label>
                        <textarea id="hqAddress" name="hqAddress" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label for="nodalOfficerName" class="block text-sm font-medium text-gray-700">Nodal Officer for SFRD Partnership <span class="text-red-500">*</span></label>
                        <input type="text" id="nodalOfficerName" name="nodalOfficerName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="nodalOfficerDesignation" class="block text-sm font-medium text-gray-700">Nodal Officer's Designation <span class="text-red-500">*</span></label>
                        <input type="text" id="nodalOfficerDesignation" name="nodalOfficerDesignation" placeholder="e.g., Lab Director" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="officialEmail" class="block text-sm font-medium text-gray-700">Official Contact Email <span class="text-red-500">*</span></label>
                        <input type="email" id="officialEmail" name="officialEmail" placeholder="e.g., partnerships@yourlab.com" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="officialPhone" class="block text-sm font-medium text-gray-700">Official Contact Phone <span class="text-red-500">*</span></label>
                        <input type="tel" id="officialPhone" name="officialPhone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                </div>
            </section>

            <!-- Section B: Accreditations & Service Portfolio -->
            <section class="bg-white p-6 rounded-lg shadow-sm form-section pl-6">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-1">Section B: Accreditations & Service Portfolio</h2>
                <p class="text-gray-500 mb-6">This helps us understand your qualifications and services, ensuring we refer the right patients to you.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Accreditations</label>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="accreditations" type="checkbox" value="NABL" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">NABL</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="accreditations" type="checkbox" value="CAP" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">CAP</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="accreditations" type="checkbox" value="ISO 15189" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">ISO 15189</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="accreditations" type="checkbox" value="Other" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Other</label></div></div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label for="accreditationDocs" class="block text-sm font-medium text-gray-700">Upload Accreditation Certificates</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="accreditationDocs" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                        <span>Upload files</span>
                                        <input id="accreditationDocs" name="accreditationDocs" type="file" class="sr-only" multiple>
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500">PDF up to 5MB each</p>
                                <p id="file-upload-names" class="text-xs text-blue-700 font-semibold"></p>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Specialized Diagnostic Services</label>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="services" type="checkbox" value="Genetic Testing (NGS, WES, WGS)" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Genetic Testing (NGS, WES, WGS)</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="services" type="checkbox" value="Metabolic Screening" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Metabolic Screening</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="services" type="checkbox" value="Biochemical Genetics" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Biochemical Genetics</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="services" type="checkbox" value="Histopathology" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Histopathology</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="services" type="checkbox" value="Cytogenetics" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Cytogenetics</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input name="services" type="checkbox" value="Routine Clinical Pathology" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">Routine Clinical Pathology</label></div></div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label for="keyTests" class="block text-sm font-medium text-gray-700">List of Key Rare Disease Tests</label>
                        <textarea id="keyTests" name="keyTests" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., Lysosomal Storage Disorder Panel, Clinical Exome Sequencing"></textarea>
                    </div>
                     <div class="md:col-span-2">
                        <label for="geographicServiceArea" class="block text-sm font-medium text-gray-700">Geographic Service Area (States where you accept samples)</label>
                        <input id="geographicServiceArea" name="geographicServiceArea" placeholder="e.g., Pan-India, or Telangana, Andhra Pradesh, Karnataka" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></input>
                    </div>
                </div>
            </section>
            
            <!-- Section C: Partnership Framework -->
             <section class="bg-white p-6 rounded-lg shadow-sm form-section pl-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-1">Section C: The SFRD Partnership Framework</h2>
                <p class="text-gray-500 mb-6">This section outlines the core commitments of our partnership.</p>
                <div class="space-y-4">
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5"><input id="priority-commitment" name="priorityCommitment" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div>
                        <div class="ml-3 text-sm"><label for="priority-commitment" class="font-medium text-gray-700">**Priority Service Commitment:** We agree to treat all SFRD-referred patients on a priority basis. <span class="text-red-500">*</span></label></div>
                    </div>
                     <div class="relative flex items-start">
                        <div class="flex items-center h-5"><input id="discount-commitment" name="discountCommitment" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div>
                        <div class="ml-3 text-sm"><label for="discount-commitment" class="font-medium text-gray-700">**Special Discount Commitment:** We agree to offer a special, preferential discount to all SFRD-referred patients. <span class="text-red-500">*</span></label></div>
                    </div>
                     <div>
                        <label for="discountOffered" class="block text-sm font-medium text-gray-700">Discount Details <span class="text-red-500">*</span></label>
                        <input type="text" id="discountOffered" name="discountOffered" required placeholder="e.g., 30% off standard rates or upload rate card" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5"><input id="workflow-commitment" name="workflowCommitment" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div>
                        <div class="ml-3 text-sm"><label for="workflow-commitment" class="font-medium text-gray-700">**Digital Workflow Integration:** We agree to integrate with the SFRD Network platform to manage referrals and updates. <span class="text-red-500">*</span></label></div>
                    </div>
                </div>
            </section>

             <!-- Section D: Operational & Financial Details -->
            <section class="bg-white p-6 rounded-lg shadow-sm form-section pl-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-1">Section D: Operational & Financial Details</h2>
                <p class="text-gray-500 mb-6">This information is necessary to set up your lab on our secure digital platform.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <h3 class="text-md font-semibold text-gray-800">Patient Coordinator Contact</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                            <input type="text" name="patientCoordName" placeholder="Full Name" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            <input type="email" name="patientCoordEmail" placeholder="Email" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            <input type="tel" name="patientCoordPhone" placeholder="Phone" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                    </div>
                     <div class="md:col-span-2">
                        <h3 class="text-md font-semibold text-gray-800">Technical Integration Contact</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                            <input type="text" name="techCoordName" placeholder="Full Name" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            <input type="email" name="techCoordEmail" placeholder="Email" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            <input type="tel" name="techCoordPhone" placeholder="Phone" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-md font-semibold text-gray-800">Bank Account Details (for co-payments)</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                            <input type="text" name="bankName" placeholder="Bank Name" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            <input type="text" name="accountNumber" placeholder="Account Number" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            <input type="text" name="ifscCode" placeholder="IFSC Code" required class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                    </div>
                     <div class="md:col-span-2">
                         <div class="relative flex items-start">
                            <div class="flex items-center h-5"><input id="copay-agreement" name="coPayAgreement" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div>
                            <div class="ml-3 text-sm"><label for="copay-agreement" class="font-medium text-gray-700">We agree to participate in the SFRD co-payment module for pre-approved cases. <span class="text-red-500">*</span></label></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Section E: Consent & Formal Agreement -->
            <section class="bg-white p-6 rounded-lg shadow-sm form-section pl-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-1">Section E: Consent & Formal Agreement</h2>
                <p class="text-gray-500 mb-6">Please have an authorized representative complete this section to formalize our partnership.</p>
                <div class="space-y-5">
                    <div class="relative flex items-start"><div class="flex items-center h-5"><input name="consent" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">I confirm I am an authorized representative of this laboratory. <span class="text-red-500">*</span></label></div></div>
                    <div class="relative flex items-start"><div class="flex items-center h-5"><input name="consent" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">I understand this partnership is voluntary and can be ended with 30 days' written notice. <span class="text-red-500">*</span></label></div></div>
                    <div class="relative flex items-start"><div class="flex items-center h-5"><input name="consent" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">I consent to SFRD storing our information and listing us as a trusted diagnostic partner. <span class="text-red-500">*</span></label></div></div>
                    <div class="relative flex items-start"><div class="flex items-center h-5"><input name="consent" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">We agree to handle all patient data with the strictest confidentiality. <span class="text-red-500">*</span></label></div></div>
                    <div class="relative flex items-start"><div class="flex items-center h-5"><input name="consentFinal" type="checkbox" required class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label class="font-medium text-gray-700">By checking this box, I confirm all information is accurate and we agree to the partnership terms. <span class="text-red-500">*</span></label></div></div>
                     <div class="pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label for="authRepName" class="block text-sm font-medium text-gray-700">Full Name of Authorized Representative <span class="text-red-500">*</span></label>
                            <input type="text" id="authRepName" name="authRepName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="authRepDesignation" class="block text-sm font-medium text-gray-700">Designation <span class="text-red-500">*</span></label>
                            <input type="text" id="authRepDesignation" name="authRepDesignation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Submission Button -->
            <div class="pt-5">
                <div class="flex justify-end">
                    <button type="submit" id="submit-button" class="w-full md:w-auto ml-3 inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Submit Partnership Form
                    </button>
                </div>
            </div>

        </form>
    </div>

    <!-- Modal for messages -->
    <div id="message-modal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
       <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div id="modal-icon-container" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full sm:mx-0 sm:h-10 sm:w-10"></div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500" id="modal-message"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="modal-close-button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../00 GLOBAL/firebase-config.js"></script>
    <script src="../js/common-form-logic.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        let app, auth, db, storage, currentUser;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) {
            console.error("Firebase init error", e);
            alert("Could not connect to services. Please try again later.");
        }

        const form = document.getElementById('lab-onboarding-form');
        const submitButton = document.getElementById('submit-button');
        const accreditationDocsInput = document.getElementById('accreditationDocs');
        const fileUploadNames = document.getElementById('file-upload-names');
        const localStorageKey = 'labOnboardingForm';

        const officialEmailInput = document.getElementById('officialEmail');
        const officialPhoneInput = document.getElementById('officialPhone');
        const patientCoordEmailInput = document.querySelector('[name="patientCoordEmail"]');
        const patientCoordPhoneInput = document.querySelector('[name="patientCoordPhone"]');
        const techCoordEmailInput = document.querySelector('[name="techCoordEmail"]');
        const techCoordPhoneInput = document.querySelector('[name="techCoordPhone"]');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("User authenticated, proceeding with Lab form.");
                if (!officialEmailInput.value && currentUser.email) {
                    officialEmailInput.value = currentUser.email;
                }
            } else {
                console.log("No user logged in, redirecting to login page.");
                window.location.href = `../00 GLOBAL/00-8 Login.html?redirect=${encodeURIComponent(window.location.href)}`;
            }
        });

        const saveFormProgress = () => {
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (form.elements[key] && form.elements[key].type !== 'file') {
                    if(data[key]){
                        if(!Array.isArray(data[key])) data[key] = [data[key]];
                        data[key].push(value);
                    } else {
                        data[key] = value;
                    }
                }
            });
            localStorage.setItem(localStorageKey, JSON.stringify(data));
        };

        form.addEventListener('input', saveFormProgress);
        window.addEventListener('load', () => {
            loadFormProgress();

            const addValidation = (input, validator, message) => {
                input.addEventListener('input', () => {
                    if (input.readOnly) return;
                    if (!validator(input.value)) {
                        showValidationError(input, message);
                    } else {
                        clearValidationError(input);
                    }
                });
            };

            addValidation(officialEmailInput, isValidEmail, 'Please enter a valid email address.');
            addValidation(officialPhoneInput, isValidPhone, 'Please enter a valid 10-digit phone number.');
            addValidation(patientCoordEmailInput, isValidEmail, 'Please enter a valid email address.');
            addValidation(patientCoordPhoneInput, isValidPhone, 'Please enter a valid 10-digit phone number.');
            addValidation(techCoordEmailInput, isValidEmail, 'Please enter a valid email address.');
            addValidation(techCoordPhoneInput, isValidPhone, 'Please enter a valid 10-digit phone number.');
        });

        accreditationDocsInput.addEventListener('change', () => {
            updateFileInputLabel(accreditationDocsInput, fileUploadNames);
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showMessage('Error', 'Not authenticated. Please wait or refresh.', 'error');
                return;
            }

            setSubmitButtonState(submitButton, true, 'Processing...');

            let isFormValid = true;
            const validateField = (input, validator, message) => {
                if (!validator(input.value)) {
                    showValidationError(input, message);
                    isFormValid = false;
                }
            };

            if (!officialEmailInput.readOnly) validateField(officialEmailInput, isValidEmail, 'Please enter a valid email address.');
            validateField(officialPhoneInput, isValidPhone, 'Please enter a valid 10-digit phone number.');
            validateField(patientCoordEmailInput, isValidEmail, 'Please enter a valid email address.');
            validateField(patientCoordPhoneInput, isValidPhone, 'Please enter a valid 10-digit phone number.');
            validateField(techCoordEmailInput, isValidEmail, 'Please enter a valid email address.');
            validateField(techCoordPhoneInput, isValidPhone, 'Please enter a valid 10-digit phone number.');

            if (!isFormValid) {
                showMessage('Error', 'Please fix the errors before submitting.', 'error');
                setSubmitButtonState(submitButton, false, 'Submit Partnership Form');
                return;
            }

            try {
                const uploadFiles = async (files, path) => {
                    const urls = [];
                    for (const file of files) {
                        const storageRef = ref(storage, `artifacts/${appId}/${path}/${currentUser.uid}_${file.name}`);
                        const snapshot = await uploadBytes(storageRef, file);
                        urls.push({ name: file.name, url: await getDownloadURL(snapshot.ref) });
                    }
                    return urls;
                };

                const accreditationDocUrls = await uploadFiles(accreditationDocsInput.files, 'lab-accreditations');

                const formData = new FormData(form);
                const labData = {};
                const multiSelects = ['accreditations', 'services'];
                multiSelects.forEach(name => labData[name] = formData.getAll(name));

                formData.forEach((value, key) => {
                    if (!multiSelects.includes(key) && form.elements[key].type !== 'checkbox' && key !== 'accreditationDocs') {
                        labData[key] = value;
                    }
                });

                const consentKeys = ['priorityCommitment', 'discountCommitment', 'workflowCommitment', 'coPayAgreement', 'consent', 'consentFinal'];
                consentKeys.forEach(key => {
                    labData[key] = form.elements[key].checked;
                });

                labData.uid = currentUser.uid;
                labData.accreditationDocUrls = accreditationDocUrls;
                labData.createdAt = serverTimestamp();
                labData.profileStatus = 'pending_review';

                const labDocRef = doc(db, `artifacts/${appId}/labs`, currentUser.uid);
                await setDoc(labDocRef, labData);

                const userDocRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
                await updateDoc(userDocRef, {
                    profileComplete: true,
                    status: 'pending_review'
                });

                showMessage('Success!', 'Your partnership form has been submitted. Our team will be in touch shortly.');
                form.reset();
                localStorage.removeItem(localStorageKey);

                setTimeout(() => {
                    window.location.href = '../00 GLOBAL/00-9 Pending Approval.html';
                }, 3000);

            } catch (error) {
                console.error("Error submitting form: ", error);
                showMessage('Submission Error', `There was an error: ${error.message}`, 'error');
            } finally {
                setSubmitButtonState(submitButton, false, 'Submit Partnership Form');
            }
        });

        function showMessage(title, message, type = 'success') {
            const modal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const iconContainer = document.getElementById('modal-icon-container');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            if (type === 'success') {
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            } else { // error
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            }
            modal.classList.remove('hidden');
        }

        document.getElementById('modal-close-button').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });
    </script>
</body>
</html>
