<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFRD Super Admin Dashboard</title>
    <link rel="icon" href="public/Logo_SFRD.jpg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .stat-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-bottom-width: 4px;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .nav-link.active {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }
        .drilldown-row {
            cursor: pointer;
        }
        .drilldown-row:hover {
            background-color: #f9fafb; /* bg-gray-50 */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar Navigation -->
        <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-20 border-b">
                <h1 class="text-2xl font-bold text-indigo-600">SFRD ADMIN</h1>
            </div>
            <div class="flex-grow">
                <nav id="sidebar-nav" class="mt-5">
                    <a href="#dashboard" class="nav-link flex items-center mt-4 py-2 px-6 active">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        <span class="mx-3">Master Dashboard</span>
                    </a>
                    <a href="#patients" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span class="mx-3">Patients</span>
                    </a>
                    <a href="#epos" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 4h5m-5 4h5"></path></svg>
                        <span class="mx-3">Expert Patient Orgs</span>
                    </a>
                    <a href="#doctors" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 016.95-5.197M15 21a6 6 0 00-9-5.197"></path></svg>
                        <span class="mx-3">Doctors</span>
                    </a>
                    <a href="#volunteers" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span class="mx-3">Volunteers</span>
                    </a>
                     <a href="#ngos" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                         <span class="mx-3">NGOs</span>
                    </a>
                    <a href="#labs" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 14l9-5-9-5-9 5 9 5z"></path><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222 4 2.222V20M12 14.75L2 9l10-5 10 5-10 5.75z"></path></svg>
                        <span class="mx-3">Labs</span>
                    </a>
                     <a href="#hospitals" class="nav-link flex items-center mt-4 py-2 px-6 text-gray-500 hover:bg-gray-200 hover:text-gray-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                        <span class="mx-3">Hospitals</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 px-6 bg-white border-b">
                 <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-800">SFRD Super Admin</h1>
                </div>
                <div class="flex items-center">
                     <div class="relative">
                        <button class="relative block h-8 w-8 rounded-full overflow-hidden shadow focus:outline-none">
                            <img class="h-full w-full object-cover" src="https://placehold.co/100x100/1f2937/FFFFFF?text=SA" alt="Super Admin avatar">
                        </button>
                    </div>
                </div>
            </div>

            <main class="p-6 sm:p-10 space-y-10">
                <!-- Dashboard View -->
                <div id="dashboard" class="page-content">
                    <section>
                        <h2 class="text-4xl font-extrabold text-gray-800">Network Overview</h2>
                        <p class="mt-1 text-lg text-gray-600">Real-time status of all stakeholders in the ecosystem.</p>
                    </section>

                    <section class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-6">
                        <a href="#patients" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-blue-500"><span class="block text-3xl font-bold" id="patients-count">0</span><span class="block text-gray-500 mt-1 text-sm">Patients</span></a>
                        <a href="#epos" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-purple-500"><span class="block text-3xl font-bold" id="epos-count">0</span><span class="block text-gray-500 mt-1 text-sm">EPOs</span></a>
                        <a href="#doctors" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-green-500"><span class="block text-3xl font-bold" id="doctors-count">0</span><span class="block text-gray-500 mt-1 text-sm">Doctors</span></a>
                        <a href="#volunteers" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-teal-500"><span class="block text-3xl font-bold" id="volunteers-count">0</span><span class="block text-gray-500 mt-1 text-sm">Volunteers</span></a>
                        <a href="#ngos" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-pink-500"><span class="block text-3xl font-bold" id="ngos-count">0</span><span class="block text-gray-500 mt-1 text-sm">NGOs</span></a>
                        <a href="#labs" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-yellow-500"><span class="block text-3xl font-bold" id="labs-count">0</span><span class="block text-gray-500 mt-1 text-sm">Labs</span></a>
                        <a href="#hospitals" class="nav-link stat-card p-4 bg-white shadow rounded-lg text-center border-red-500"><span class="block text-3xl font-bold" id="hospitals-count">0</span><span class="block text-gray-500 mt-1 text-sm">Hospitals</span></a>
                    </section>
                    
                    <section class="grid md:grid-cols-2 gap-8 mt-12">
                         <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold text-gray-800">New Onboarding Requests (Pending Verification)</h3>
                             <div class="mt-4 space-y-4" id="new-requests-list"></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold text-gray-800">Key Performance Indicators</h3>
                             <div class="mt-4 space-y-3" id="kpi-list"></div>
                        </div>
                    </section>
                </div>
                
                <!-- DRILLDOWN VIEWS -->
                <div id="drilldown-level-1" class="page-content hidden"></div>
                <div id="drilldown-level-2" class="page-content hidden"></div>

                <!-- Profile Detail Modal -->
                <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div class="flex justify-between items-center p-4 border-b">
                            <h2 class="text-2xl font-bold text-gray-800">User Profile Details</h2>
                            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                        </div>
                        <div id="modal-content" class="p-6 overflow-y-auto">
                            <!-- User details will be injected here by JS -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="./00 GLOBAL/firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs, query, where, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase init error", e);
            alert("Could not connect to services. Please try again.");
            window.location.href = './00 GLOBAL/00-8 Login.html';
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('No user signed in. Redirecting to login.');
                window.location.href = './00 GLOBAL/00-8 Login.html';
                return;
            }

            const userRef = doc(db, `artifacts/${appId}/users`, user.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists() && docSnap.data().role === 'admin') {
                console.log('Admin authenticated. Loading dashboard...');
                // Replace login page in history to prevent back-button issue
                history.replaceState(null, '', '#dashboard');
                loadDashboard(user, docSnap.data());
            } else {
                console.warn('User is not an admin. Redirecting...');
                await signOut(auth);
                alert('Access Denied: You do not have permission to view this page.');
                window.location.href = './00 GLOBAL/00-8 Login.html';
            }
        });

        async function loadDashboard(user, userData) {
    document.body.style.display = 'block';

    // --- Populate Counts in Real-Time ---
    const roles = ['patient', 'epo', 'doctor', 'volunteer', 'ngo', 'lab', 'hospital'];
    roles.forEach(role => {
        const q = query(collection(db, `artifacts/${appId}/users`), where('role', '==', role), where('status', '==', 'approved'));
        
        onSnapshot(q, (snapshot) => {
            const countEl = document.getElementById(`${role}s-count`);
            if (countEl) {
                countEl.textContent = snapshot.size;
            }
        });
    });

    // --- Load KPIs --- 
    const kpiList = document.getElementById('kpi-list');
    const allUsersQuery = query(collection(db, `artifacts/${appId}/users`));
    onSnapshot(allUsersQuery, (snapshot) => {
        const approvedUsers = snapshot.docs.filter(doc => doc.data().status === 'approved');
        kpiList.innerHTML = `
            <div class="flex justify-between items-center">
                <p class="text-gray-600">Total Approved Network Partners</p>
                <p class="font-bold text-lg text-indigo-600">${approvedUsers.length}</p>
            </div>
        `;
    });

    // --- Load Pending Requests in Real-Time ---
    const requestsList = document.getElementById('new-requests-list');
    const pendingQuery = query(collection(db, `artifacts/${appId}/users`), where('status', '==', 'pending_approval'));

    onSnapshot(pendingQuery, (snapshot) => {
        if (snapshot.empty) {
            requestsList.innerHTML = '<p class="text-gray-500">No new onboarding requests.</p>';
        } else {
            requestsList.innerHTML = snapshot.docs.map(doc => {
                const data = doc.data();
                const name = data.displayName || data.fullName || data.orgName || data.hospitalName || data.labName || 'N/A';
                const email = data.email || 'N/A';
                return `
                    <div id="request-${doc.id}" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold">${name}</p>
                            <p class="text-sm text-gray-500">Role: ${data.role} | Email: ${email}</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button data-id="${doc.id}" data-role="${data.role}" class="view-btn px-3 py-1 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">View</button>
                            <button data-id="${doc.id}" class="approve-btn px-3 py-1 text-sm font-medium text-white bg-green-500 rounded-md hover:bg-green-600">Approve</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    });

    // --- Add Event Listeners for Approval/Rejection ---
    const profileModal = document.getElementById('profile-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('close-modal-btn');

    requestsList.addEventListener('click', async (e) => {
        const target = e.target;
        const userId = target.dataset.id;
        if (!userId) return;

        if (target.classList.contains('approve-btn')) {
            const userRef = doc(db, `artifacts/${appId}/users`, userId);
            try {
                await updateDoc(userRef, { status: 'approved' });
                console.log(`User ${userId} approved successfully.`);
            } catch (error) {
                console.error('Error approving user:', error);
                alert('Failed to approve user. Please try again.');
            }
        } else if (target.classList.contains('view-btn')) {
            const role = target.dataset.role;
            if (!role) {
                alert('Cannot view details: user role is missing.');
                return;
            }
            const collectionName = role === 'patient' ? 'patients' : `${role}s`;
            const docRef = doc(db, `artifacts/${appId}/${collectionName}`, userId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    displayProfileInModal(docSnap.data());
                } else {
                    alert('Could not find the detailed application data.');
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
                alert('Failed to fetch user details. Please try again.');
            }
        }
    });

    function displayProfileInModal(data) {
        // Intelligent rendering for specific data keys
        const renderValue = (key, value) => {
            if (!value) return '<span class="text-gray-400">Not provided</span>';

            // Photo URL
            if (key.toLowerCase().includes('photourl') && typeof value === 'string') {
                return `<img src="${value}" alt="Profile photo" class="h-24 w-24 rounded-lg object-cover shadow-md">`;
            }

            // Timestamps
            if (value && typeof value.toDate === 'function') {
                return value.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            // Tag-based fields
            const tagFields = ['skills', 'primarySpecialization', 'medicalSpecialities', 'contribution', 'collaborations', 'commitments', 'accreditations', 'taxStatus', 'symptomsOther'];
            if (tagFields.includes(key) && (Array.isArray(value) || typeof value === 'string')) {
                const items = Array.isArray(value) ? value : value.split(',');
                if (items.length === 0 || (items.length === 1 && !items[0])) return '<span class="text-gray-400">None</span>';
                return items.map(item => `<span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${item.trim()}</span>`).join(' ');
            }

            // Medical Reports (array of URLs)
            const fileArrayKeys = ['medicalReportUrls', 'keyDocumentUrls', 'credentialUrls', 'resumeUrls', 'accreditationCertUrls'];
            if (fileArrayKeys.includes(key) && Array.isArray(value)) {
                if (value.length === 0) return '<span class="text-gray-400">No files uploaded</span>';
                return `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-2">` + value.map(url => {
                    const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(url);
                    const fileName = url.split('/').pop().split('?')[0]; // Get filename from URL
                    if (isImage) {
                        return `
                            <a href="${url}" target="_blank" class="group block w-full aspect-w-1 aspect-h-1 bg-gray-100 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-offset-gray-100 focus-within:ring-indigo-500">
                                <img src="${url}" alt="Medical report preview" class="object-cover w-full h-full group-hover:opacity-75">
                                <div class="absolute bottom-0 left-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate w-full">${decodeURIComponent(fileName)}</div>
                            </a>
                        `;
                    } else {
                        return `
                            <a href="${url}" target="_blank" class="group flex flex-col items-center justify-center w-full h-24 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 hover:bg-gray-200">
                                <svg class="w-8 h-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                <span class="mt-2 text-xs text-gray-500 text-center px-1 truncate">${decodeURIComponent(fileName)}</span>
                            </a>
                        `;
                    }
                }).join('') + '</div>';
            }

            // Generic File uploads (arrays of objects with name/url)
            if (key.toLowerCase().includes('urls') && Array.isArray(value)) {
                 return value.map(item => {
                    if(typeof item === 'object' && item.url) return `<a href="${item.url}" target="_blank" class="text-blue-600 hover:underline flex items-center space-x-2"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg><span>${item.name || 'View File'}</span></a>`;
                    return '';
                }).join('<br>');
            }

            // Single file upload (string URL)
            if (key.toLowerCase().includes('url') && typeof value === 'string' && !key.toLowerCase().includes('photo')) {
                 return `<a href="${value}" target="_blank" class="text-blue-600 hover:underline">View Document</a>`;
            }

            // Boolean values
            if (typeof value === 'boolean') {
                return value ? '<span class="text-green-600 font-semibold">Yes</span>' : '<span class="text-red-600 font-semibold">No</span>';
            }

            // Default object/array formatting
            if (typeof value === 'object' && value !== null) {
                return `<pre class="bg-gray-100 p-2 rounded-md text-sm whitespace-pre-wrap">${JSON.stringify(value, null, 2)}</pre>`;
            }

            // Default string value
            return value;
        };

        let contentHtml = '<dl class="divide-y divide-gray-200">';
        for (const key in data) {
            // Skip keys we don't want to show in the detail view
            if (['profileComplete', 'profileCompletedAt'].includes(key)) continue;

            contentHtml += `
                <div class="py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500 capitalize">${key.replace(/_/g, ' ')}</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">${renderValue(key, data[key])}</dd>
                </div>
            `;
        }
        contentHtml += '</dl>';
        modalContent.innerHTML = contentHtml;
        profileModal.classList.remove('hidden');
    }

    closeModalBtn.addEventListener('click', () => {
        profileModal.classList.add('hidden');
    });

    // Close modal on outside click
    profileModal.addEventListener('click', (e) => {
        if (e.target.id === 'profile-modal') {
            profileModal.classList.add('hidden');
        }
    });

    // --- UI Logic ---
    const pageContents = document.querySelectorAll('.page-content');
    function switchTab(targetId) {
        pageContents.forEach(content => content.classList.toggle('hidden', content.id !== targetId));
        document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.getAttribute('href') === `#${targetId}`))
    }
    // --- Drilldown Logic ---
    const drilldownContainer = document.getElementById('drilldown-level-1');

    async function showDrilldown(collectionName, role, title, headers, rowGenerator) {
        let q;
        if (collectionName === 'users') {
            q = query(collection(db, `artifacts/${appId}/${collectionName}`), where('role', '==', role));
        } else {
            // For patients, we fetch all documents from the dedicated 'patients' collection
            q = query(collection(db, `artifacts/${appId}/${collectionName}`));
        }
        const snapshot = await getDocs(q);
        const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const renderTable = (data) => {
            return `
                <tbody class="bg-white divide-y divide-gray-200">
                    ${data.map(rowGenerator).join('')}
                </tbody>
            `;
        };

        let tableContainerHtml = `
            <section>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                         <a class="nav-link p-2 rounded-full hover:bg-gray-200" href="#dashboard">
                            <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </a>
                        <h2 class="text-3xl font-extrabold text-gray-800">${title}</h2>
                    </div>
                    <div class="w-1/3">
                        <input type="text" id="table-search" placeholder="Search by name, email, etc..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            </section>
            <section class="mt-8 bg-white rounded-lg shadow">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>${headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>
                        ${renderTable(allData)}
                    </table>
                </div>
            </section>
        `;
        drilldownContainer.innerHTML = tableContainerHtml;
        switchTab('drilldown-level-1');

        // Add search functionality
        const searchInput = document.getElementById('table-search');
        searchInput.addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = allData.filter(item => {
                const name = (item.displayName || item.fullName || item.orgName || item.hospitalName || item.labName || '').toLowerCase();
                const contact = (item.email || item.officialEmail || item.primaryEmail || item.contactPhone || '').toLowerCase();
                const specializations = Array.isArray(item.primarySpecialization) ? item.primarySpecialization.join(' ').toLowerCase() : '';
                const skills = Array.isArray(item.skills) ? item.skills.join(' ').toLowerCase() : (item.skills || '').toLowerCase();
                return name.includes(searchTerm) || contact.includes(searchTerm) || specializations.includes(searchTerm) || skills.includes(searchTerm);
            });
            drilldownContainer.querySelector('tbody').outerHTML = renderTable(filteredData);
        });

        // Add row click listener
        drilldownContainer.querySelector('tbody').addEventListener('click', (e) => {
            const row = e.target.closest('.drilldown-row');
            if (row) {
                const userId = row.dataset.id;
                const userData = allData.find(item => item.id === userId);
                if (userData) {
                    displayProfileInModal(userData);
                }
            }
        });
    }

    document.body.addEventListener('click', e => {
        const link = e.target.closest('a.nav-link');
        if (link && link.getAttribute('href')?.startsWith('#')) {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1);

            if (roles.includes(targetId.slice(0, -1))) {
                const role = targetId.slice(0, -1);
                const collectionName = role === 'patient' ? 'patients' : 'users';
                
                let headers = ['Name', 'Contact', 'Status'];
                let keyColumnHeader = '';
                if (role === 'doctor' || role === 'hospital') keyColumnHeader = 'Specializations';
                if (role === 'volunteer') keyColumnHeader = 'Skills';
                if (keyColumnHeader) headers.splice(1, 0, keyColumnHeader);

                const rowGenerator = (item) => {
                    const name = item.displayName || item.fullName || item.orgName || item.hospitalName || item.labName || 'N/A';
                    const contact = item.email || item.officialEmail || item.primaryEmail || item.contactPhone || 'N/A';
                    const statusClass = item.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    
                    let keyColumnData = '';
                    if (keyColumnHeader) {
                        let skills = [];
                        if (role === 'doctor' || role === 'hospital') skills = item.primarySpecialization || item.medicalSpecialities || [];
                        if (role === 'volunteer') skills = Array.isArray(item.skills) ? item.skills : (item.skills || '').split(',');
                        
                        keyColumnData = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${skills.slice(0, 2).join(', ')}${skills.length > 2 ? '...' : ''}</td>`;
                    }

                    return `
                        <tr class="drilldown-row" data-id="${item.id}">
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${name}</td>
                            ${keyColumnData}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${item.status || 'N/A'}</span></td>
                        </tr>
                    `;
                };
                showDrilldown(collectionName, role, `${role.charAt(0).toUpperCase() + role.slice(1)}s`, headers, rowGenerator);
            } else {
                switchTab(targetId);
            }
        }
    });
    switchTab('dashboard');
}
    </script>
</body>
</html>

